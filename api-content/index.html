{"posts":[{"title":"更换 AlphaSSL 单域名证书加速国内 OCSP 认证遇到的坑","content":"最近决定更换一下我的博客大陆访问时候所用的 SSL 证书，于是到 SSL2BUY 上买了一个 AlphaSSL 的单域名证书，然而这才是坑的开始。因为按照最初的设置，这货弄出来只支持 WWW Domain, 显然这是不科学的。 更换背景 原因及分析 起因是最近一次测试国内访问速度的时候，发现原来使用的 COMODO ECC 单域名证书在进行在线证书状态协议 OCSP 这种阻断式认证的时候，延时在某些情况下可能会达到 2s. 这简直就是一件不能忍的事情。 COMODO ECC 的 OCSP 校验地址是 http://ocsp.comodoca.com, 感兴趣的话可以测试一下延迟，国内应该是解析到一个英国的 IP 上。另外附上COMODO ECC 的 CRL 证书撤销列表地址：http://crl.comodoca.com/COMODOECCDomainValidationSecureServerCA.crl 然而我国内访问所使用的主机供应商主机壳并不能开启 OCSP Stapling 来避免这一延迟。因此只有采取更换有更快 OCSP 访问速度的证书来改善访问体验。 为什么是 AlphaSSL 这个很简单， AlphaSSL 的 OCSP 校验地址是 http://ocsp2.globalsign.com/gsalphasha2g2, 这个地址通过测试会发现大陆有众多访问节点，延迟极低。采用同样服务器的还有 GlobalSign 的证书，毕竟是一家，但由于定位问题，价格肯定是 AlphaSSL 便宜。 什么？为什么不申请那些由国内 CA 签发的免费证书，比如数安时代? 还是信任问题，WoSign 事件早就把国内 CA 的信用败光了。况且看了下数安的申请流程，还要联系客服什么的，真是麻烦。 为什么不选择 AlphaSSL WildCard 而选择单域名证书 市面上的 AlphaSSL WildCard 除了正规购买的，就是通过滥用某主机商福利生成的。后者虽然免费，但风险不低，随时可能被 Revoke, 且有违道德。 再一个就是我目前没有泛域名使用需求，购买价格高昂的泛域名实属没事找事。 选择 SSL2BUY 纯粹是因为其价格和口碑，比淘宝上口碑特别好的代理商价格还便宜。 购买流程 这个似乎没有什么好写的，下单，付款，提交 CSR, 进行 DNS 认证然后就能收到证书。 坑及解决方案 生成的证书仅支持 WWW 域名而不支持 non-WWW 域名 最开始，我生成的证书仅包括了 www.woadzs.me 这个 WWW 域名而不包含 woadzs.me 这个裸域。这显然是不正常的。后来发现这是标准证书申请的一个坑，泛域名压根儿碰不到这种情况。 根据 Domain Verification Changes 提供的信息，按照 GlobalSign 的规定为了 SSL 同时支持 WWW 和 non-WWW, 正确的操作应该是提交以 www.example.com 为 Common Name 的 CSR. 在认证的时候，无论是通过 URL 还是 DNS TXT 记录认证，都必须在 example.com 下进行域名所有权验证。 正确的操作只有上面一条，手抖把 non-WWW 写成了 CN 或者是使用 WWW 进行了验证或者是其他排列组合，都只能收到“残废”证书。 在线补全证书链不正常 我们都有拿到新证书先补全证书链的习惯，而我们也似乎都习惯于使用在线的证书补全工具，比如 MySSL.com 证书链修复 和 certificatechain.io. 然而这些在线证书链在补全 AlphaSSL Standard Certificate 的时候，所提供的中级证书 Intermediate Certificates 并不是用来签署我这个新证书的那一个。 **原因是 GlobalSign 和 AlphaSSL 为 2014 年 3 月 31 号之后签署的新 DV 证书启用了新的中级证书，而网上自动补全的统统是给补老中级证书。**新老中级证书快速判断的标准就是有效期： 新中级证书有效期为 20 February 2024 老中级证书有效期为 02 August 2022 适用于 AlphaSSL 的新老中级证书，除了在证书签发的通知邮箱里面会告知具体链接，也可以在 Install Root Certificate 找到。 PS: 无论是 AlphaSSL 还是 Let's Encrypt, 现在的中级证书都是基于 RSA 2048 bits 的， ECC 的中级证书还需要等等。Let's Encrypt 给出的时间点是 2018 年 Q3 然而已经跳票多次. 而 AlphaSSL 没有给出具体时间节点。 对主机壳和 Netlify 的碎碎念 求开通 HSTS 功能 ← 本条仅针对主机壳 求开通 OCSP 装订配置 求开通 ECC 证书支持 ← 本条仅针对 Netlify 后记——目前（2018 年 4 月）网站的 SSL 配置及虚拟空间特性 大陆访问（主机壳） AlphaSSL ECDSA 256 bits 全站 HTTPS 全站 HTTP/2 静态资源访问大陆 CDN 网页本体访问香港 CDN 详细证书信息可查看 MySSL.com 海外访问（Netlify） Let's Encrypt RSA 2048 bits 全站 HTTPS 且加入 HSTS 标记 全站 HTTP/2 全站访问 Amazon CloudFront CDN 详细证书信息可查看 SSLLabs ","link":"https://blog.woadzs.me/post/AlphaSSL_standard_ssl2buy/"},{"title":"利用 Pump 修复 gulp-uglify 报错","content":"在安装完 Hexo 后很多人都会对自己的静态博客进行优化，期中有相当一部分人就会用到 gulp-uglify 这个插件来压缩 js 文件。然而有时候会遇到插件报错，这个时候可以使用 Pump 来替代原有的 Pipe 就可以解决问题。 Pipe 与 Pump 的区别 网上很多利用 gulp-uglify 的教程里面都会使用 Pipe, 然而一旦发生错误，这些错误并不会通过管道流( piped streams )传播，因此源流并不会因为目标流的关闭而关闭。 Pump 则能规范化这些问题并能在回调中把这些错误显示出来，简而言之， Pump 能让你更好地地位错误发生点。 一种较为常见的 gulpfile 文件范例 网上很多教程 gulpfile 中关于 gulp-uglify 的部分都是这么写的： // example of a common gulpfile var gulp = require('gulp'); var uglify = require('gulp-uglify'); gulp.task('compress', function () { // returns a Node.js stream, but no handling of error messages return gulp.src('lib/*.js') .pipe(uglify()) .pipe(gulp.dest('dist')); }); 当我们实际运行的时候可能会遇上下面这种不知所云的错误，你压根儿没办法知道到底是哪个鸟文件其中的哪一行出现了问题。 Node.js 遇到这种错误的一般做法也是： By default, Node.js handles such exceptions by printing the stack trace to stderr and exiting. 至于处理办法，传统的做法就是分流进行处理，这里不在赘述。其实是自己压根儿不懂。 具体解决办法可以参见这里。 使用 Pump Pump 就是一个比较取巧的模组，能帮你解决 Pipe 搞不定的那些事，首先可以通过如下命令安装 Pump: npm install pump 然后上文的代码能够很简单的更改为为： var gulp = require('gulp'); var uglify = require('gulp-uglify'); var pump = require('pump'); gulp.task('compress', function (cb) { pump([ gulp.src('lib/*.js'), uglify(), gulp.dest('dist') ], cb ); }); 这样以来 Pump 就可以很轻松的告诉你到底哪儿有错，方便你进行调试。 而且有时候， Pump 会很神奇地完美执行好 Pipe 会报错的代码，因此可能到最后，你得到的就是完美的输出结果。其实是我又没弄懂哪儿出问题了 参考文献： Why Use Pump? gulp-uglify插件最新pump使用教程 ","link":"https://blog.woadzs.me/post/fix_gulp_uglify_error/"},{"title":"FTP 部署 Hexo 博客到虚拟主机","content":"自从博客在 Github 和 Coding 建站完成后，发现这两并不能部署自定义 SSL, 因此准备另谋出路。很快决定了国外的解决方案是 Netlify. 国内的速度本来试过 魔门云， 但依旧发现其免费套餐解析节点在台湾和日本，国内的访问速度并不乐观。而其付费起步就是每月一百软妹币以上，不是很划算。Coding.net又不支持自定义 SSL 证书，导致多地部署不能很方便地同时实现 HTTPS 访问。 终于，我想起了我的老朋友 主机壳（链接带推广，介意可自行搜索） 为什么选择主机壳？ 要回答这个问题，我们可以先回答： 为什么选择虚拟主机而不是 VPS 或者是 CDN？ 首先，要明确的是选购服务的主要目的为加快中国大陆访问速度。 仅网页服务器而言，VPS 略显杀鸡用牛刀，且价格昂贵，访问速度最快的香港可用区就更贵了 不需要用香港 VPS 来搞些不和谐的事情 几乎不存在价廉物美的香港 CDN, 各种标榜免费服务的 CDN 并不会真正给你部署成本高昂的香港节点。 国内免费 CDN 需要备案，然而我懒得搞…… 虚拟主机维护不用费心 总之，从建站角度来说，虚拟主机价廉物美易于管理，位于香港的虚拟主机速度更是可以比拼国内。 为什么是主机壳而不是其他虚拟主机 其实还是之前跟主机壳有过py交易，比较熟悉。他们家有几项是很多别的主机商所没有的： 直接部署在 CDN 上，支持将图片等文件放在内地节点，其他诸如 HTML 等可以直接访问香港节点 支持 ECC 证书，ECC 证书有助于减少 SSL 的握手时间， SSL证书可以自己上传 最低配价格并不是那么贵，对于还没几个访问量的我来说显得不太会浪费 自带一定程度的抗 DDoS 因为直接部署在 CDN 上，不用担心主机 IP 暴露或者是被其他邻居误伤 是不是说其他虚拟主机就不好呢，也不一定，至少在测试的时候，主机公园的香港空间（大流量）测试站就给我留下了深刻印象。然而他家是在价格对于菜鸡博主来说是在有些高，但对于访问量不是特别小的用户来说，倒也是可以尝试。 部署 Hexo 到虚拟主机 服务端设置 如何购买下单什么的就不说了，我的主机都用了两年了，以前用的是 WordPress, 然而现在转全静态过后，一般虚拟主机的 PHP 和数据库都基本上用不到了。 因此，在服务端需要设置的是： 删除数据库 进入 FTP 并清空网页根目录所有文件（每个服务商目录不一样，主机壳直接在 FTP 根目录全清除就好） 上传 SSL 证书并做将域名的国内线路访问解析过来 到这里服务端要做的就结束了。 Hexo 设置 安装并使用 FTPSync 部署工具 安装 hexo-deployer-ftpsync npm install hexo-deployer-ftpsync --save 然后在站点 _config.yml 文件中添加并修改一下配置，具体操作可以参考官方文档 这里讲一下多种部署方式如何写，比如我现在用的 Git 与 FTP 同时部署 Hexo： deploy: - type: ftpsync host: ftp.example.com user: username pass: password #remote: [remote] port: 21 #我在主机上设置了.htaccess 来实现 HTTPS 强制访问，此处可确保每次同步不会删除虚拟主机上的 .htaccess ignore: ['/.htaccess'] #connections: [connections] #verbose: [true|false] - type: git repo: Github: git@github.com:woadzs/woadzs.github.io.git,master Conding: git@git.coding.net:WoadZS/woadzs.git,master 注意每个 - 后面有一个空格，来区分不同的部署方式。并且建议将 FTP 方式放在 Git 之前，因为 FTP 部署插件有个小 Bug, 部署完后，会在命令行界面卡在 INFO Deploy done: ftpsync 没反应，把 FTP 前置可以一定程度上解决这个问题。 解决完后就可以使用 hexo d 来正常部署静态博客了。 通过.htaccess 实现强制 HTTPS 访问 由于很多虚拟空间都是使用 Apache 来做的网页呈现，因此可以很方便的使用 .htaccess 来实现强制 HTTPS 访问。 如果你跟我一样使用的是主机壳的服务，这里有一个坑，在主机壳控制面板 HTTPS 证书管理 页面，你能看到这么一句提示： 如需.htaccess判断HTTPS请求，请判断用户请求header头的KERSSL值是否为on。Apache不使用443端口，只能使用判断规则RewriteCond %{HTTP:KERSSL} !on 因此，我在 .htaccess 只能这么写 RewriteEngine On RewriteCond %{HTTP:KERSSL} !on RewriteRule ^(.*)$ https://woadzs.me/$1 [R=301,L] 请把上面我的域名改成你的就能用了。 如果其他运营商没有这个坑，可以试试常规的写法，注意最好在最后面的 [L,R] 改成 [L,R=301] 强制启用 301 跳转，这样比默认的 302 跳转更有利于搜索引擎收录。具体原理可以参阅这篇文章。 如果你想更骚气一些，可以这么写（其实这是官方推荐做法），但不保证在老版本的 Apache 上有用： Redirect 301 / http://www.newdomain.com/ 一行就搞定，简洁明了。 效果 没有对比就没有伤害，下图 BigKfish 是我朋友的静态站，测试时刚布置没多久，什么都没有。国内直接访问部署在 Netlify 的东京 Amazon 节点。 测试时间是北京时间凌晨三点左右，国际线路并不拥堵，因此 BigKfish 还呈现了不少绿色，然而白天则会祖国山河一片红。 上面这张图就是正午时分的对比效果（湖北节点是崩了，所以都是红的），日本节点的 BigKfish 访问效果下降得更厉害。夜间就不测试了，差别只会更悬殊。 ","link":"https://blog.woadzs.me/post/ftp_deploy_to_VH/"},{"title":"新站落成","content":"自己的博客，之前一直是基于 WordPress 搭载在某虚拟空间上的，虽说这个服务商也带有 CDN 的功能，但效果实在是不敢恭维，也有可能是钱没给够哈哈。于是乎现在想起来转投到静态博客的怀抱，尝试使用 Hexo 加上 Github Page Coding Page 来做这个博客。 基本思路 双线部署，国外走 Github Page 国内走 Coding Page，这样的话对于国内外访问速度都有保障 强制开启 SSL 支持，不然的话国内访问可能满屏你的时间非常宝贵 如果可能，寻找靠谱的 CDN 服务商 利用 OneDrive 进行同步，达到多台电脑都能更新博客的目的 环境搭建 本机必须安装的组件有： Node.js 推荐安装 LTS 也就是 Long Term Support 版本 Git 出于个人使用习惯，我还安装了： OneDrive 基本上不用自行安装，Windows 系统自带，如果你使用 Mac, 可以考虑别的同步型网盘 Visual Studio Code 这是我的主力 Markdown 编辑器 开始安装 安装 Hexo 具体如何部署 Hexo 网上已经有很多文章了，这里不再赘述，另外可以参考 Hexo 官方文档 。 多 Git 平台部署 前面说到希望能部署到国内外两个平台，部署方式是通过 Git 生成配对 ssh 首先要做是生成与两个平台同步间需要使用的安全密钥，这里假设多个 Git 都用的一个邮箱注册的，在 Git Bash 界面中输入一下命令 ssh‐keygen ‐t rsa ‐C &quot;your_email@example.com&quot; 然后一路回车就可以，生成好的密钥与公钥一般存放在电脑的 ~/.ssh/ , 假如你使用的 Windows 的系统并且用户名为 WoadZS , 那么你就可以在 C:\\Users\\WoadZS\\.ssh 这个文件夹找到你的密钥： id_rsa.pub //这是你的公钥 id_rsa //这是你的私钥 你需要使用记事本打开 id_rsa.pub 并复制里面的所有内容，到你所要使用的平台，比如说 Github 和 Coding.net 上加入到 SSH 密钥中。 具体加入方式参考： Adding a new SSH key to your GitHub account SSH公钥配置 | Coding.net 测试连通 Git Bash中输入 # 测试 Github 连接 ssh -T git@github.com # 测试 Coding.net 连接 ssh -T git@git.coding.net 平台可能会返回诸如以下提示，直接输入 yes 即可(以 Github 为例)： The authenticity of host 'github.com (192.30.252.1)' can't be established. RSA key fingerprint is SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8. Are you sure you want to continue connecting (yes/no)? 如果成功，将返回以下消息： Hi username! You've successfully authenticated, but GitHub does not provide shell access. 建立 Git 平台的 Pages 页面 网上教程众多，不做赘述，官方指导： Configuring a publishing source for GitHub Pages 开始使用 Coding Pages 在 Hexo 的主配置文件 _config.yml 中，将 deploy 部分字段改为如下多 Git 平台设置方式 # Deployment ## Docs: https://hexo.io/docs/deployment.html deploy: type: git repo: Github: git@github.com:woadzs/woadzs.github.io.git,master Conding: git@git.coding.net:WoadZS/woadzs.git,master 多平台同步 这里讲一下怎么在多台电脑之间同步 Hexo 工作目录，以便于我们在多台电脑上都可以进行博客管理。 网上一般的做法是通过 Git 进行管理，这样其实对小白们并不是太友好，也不是特别方便。 这里采用同步网盘的方法进行。 找到新电脑上已经同步过来的 Hexo 目录，同时保证新电脑上都安装了 Node.js 和 Git. 然后开始 Hexo 同步素质三连 : # 在新电脑安装 Hexo npm install -g hexo-cli # 注意这里千万不要进行hexo初始化：hexo init # 否则之前的hexo配置参数都会重置 # 安装依赖库 npm install # 安装部署相关配置 npm install hexo-deployer-git 其实就跟全新安装 Hexo 差不多，唯一的区别是少了 hexo init 命令， 接下来请参考上文 多 Git 平台部署 的部分，在新电脑配置 ssh 连接即可。 国内外分流访问 假设你已经在某处购买了属于自己的域名 证书问题及设置 这里有一个问题，因为国内部署的空间是 Coding.net , Coding.net 原生提供的证书方式为 HTML 验证的 Let's Encrypt 证书，因此需要确保验证的时候 DNS 解析是在 Coding.net 的页面上。阿里云 DNS 会对访问进行分流，但无法避免的是我们没法对 Let's Encrypt 的验证做单独解析，因此用一个域名对国内外同时进行加密访问很难实现。 如果 Coding.net 能提供自定义证书，则问题就很好解决了。 通过一些列测试证明， Coding.net 的 CDN 也能在全球范围内提供可以接受的访问速度，因此可以将访问直接引流到 Coding.net 上， Github 作为备份。 Coding.net 的 SSL 部署是在你的静态页面 repository 的 Pages服务 里面一键生成。 最后建议开启 强制 HTTPS 访问 以加强安全性。 如果要将流量主要导流到 Github ，因为 Github 无法为自己的域名绑定 SSL , 所以正确的做法是利用 Netlify 来为 Github Pages 启用 SSL 访问（可以自己上传自己的证书），并且还能开启 HSTS ，这也算隐藏福利之一。 Netlify 从国内访问主要是访问其在日本或者新加坡的 CDN 节点，大陆访问速度不如 Coding.net 但海外访问速度很快。 因此证书的分流设置的结论就是： 现在只能顾着一头，最多只能一个站有 SSL 才能方便管理，除非有更好的平台提供更好的解决方案； 根据你的阅读群体，大陆读者居多的请将流量导入 Coding.net，反之导入 Netlify; 如果你不执念于 SSL， 虽然不建议这么做，那你可以直接使用 DNS 进行分流，国内走 Coding.net， 国外走 Netlify; DNS 设置 本站使用的是 阿里云 DNS 云解析免费版 之所以不使用 DNSPod 的原因是其免费版 CNAME 设置条数限制实在太低。 如果前文的判断，你只想把流量导入其中一个平台，那简单，以 Coding Pages 为例，直接设定单一 CNAME 记录就行了： 如果你想进行国内外分流，在解析线路出可以直接制定国内和海外的 CNAME 记录。 CDN 网站是否使用 CDN 是一个见仁见智的问题，如果是直接使用的 Coding.net 或者 Github 的服务，几乎不用再额外配置 CDN . 如果是自己假设的服务器，最好还是再找一个靠谱的 CDN. 其实很多个人博客的域名是没有经过备案的，没有备案的域名是无法使用大陆节点的 CDN 的，最多也就是走香港或者日本的节点。所以使用之前注意考虑 其他 图床 本站图床用的是 新浪微博图床， 为了方便使用，使用了 新浪微博图床 这款 Chrome 插件. 更多的图床选择：SM.MS 主题 本站所用主题为 Viosey 开发的 Matearial PS: 于 2018 年 4 月更新为 iTimeTraveler 开发的 HikerNews 插件 Hexo-Prism-Plugin 代码高亮 编写 编写所用工具为：Visual Studio Code ， 并配合插件： vscode-hexo Provides Hexo init, new, generate, server, deploy, publish, clean commands in the VSCode Editor. Code Runner Run your codes in VSCode Jupyter Notebook 这个不是插件，是 Python 的笔记本软件，可以直接导出为 Markdown 格式进行编辑再发布。 ","link":"https://blog.woadzs.me/post/hello_world/"}]}